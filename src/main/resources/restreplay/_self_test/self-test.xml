<?xml version="1.0" encoding="UTF-8"?>
<restReplay>
    <protoHostPort>http://localhost:${SELFTEST_PORT}</protoHostPort>



    <testGroup ID="login" autoDeletePOSTS="false">
        <test ID="selftestToken">
            <expectedCodes>200</expectedCodes>
            <method>GET</method>
            <uri>/tagonomy?mock=token</uri>
        </test>
    </testGroup>



    <testGroup ID="selftestGroup" autoDeletePOSTS="false">
        <vars>
            <var ID="SELFTEST_SERVER">http://localhost:${SELFTEST_PORT}</var>
        </vars>
        <test ID="selftestToken">
            <expectedCodes>200</expectedCodes>
            <method>GET</method>
            <uri>/tagonomy?mock=token</uri>
        </test>
        <test ID="selftest1">
            <expectedCodes>200</expectedCodes>
            <method>GET</method>
            <uri>${SELFTEST_SERVER}/tagonomy?mock=true&amp;foo=${TOKEN_ID}</uri>
            <vars>
                <var ID="TOKEN_ID">${selftestToken.got("//status")}</var>
            </vars>
        </test>
        <test ID="selftestUseMutator">
            <expectedCodes>200</expectedCodes>
            <method>POST</method>
            <uri>/tagonomy?mock=true</uri>
            <filename>_self_test/content-mutator-test.json</filename>
            <mutator type="ExcludeFields">
                <expected>
                    <code range="200">*</code>
                    <code range="200-299">numOfDrafts</code>
                    <code range="400-499,500-599">book_id, course_id</code>
                </expected>
            </mutator>
        </test>
        <test ID="selftestUseToken">
            <expectedCodes>200</expectedCodes>
            <method>GET</method>
            <uri>/tagonomy?mock=true&amp;name=selftestUseToken</uri>
            <headers>
                <header name="x-authorization">${selftestToken.got("//data")}</header>
                <header name="x-method">${selftestToken.method}</header>
            </headers>
            <!--This causes a warning.  And it breaks auto delete with the erroneous url.
            Keeping this here for development of two error tests.
            TODO: Develop tests that fire these, and also demonstrate the ways to construct a url, and a deleteURL.
            <deleteURL>${result.url.protocol}://${result.url.authority}${result.url.path} -:: ${result.protoHostPort} ::-</deleteURL>
            -->
        </test>
        <test ID="selftestUseTokenPOST">
            <expectedCodes>200</expectedCodes>
            <method>POST</method>
            <uri>/tagonomy?mock=true</uri>
            <filename>_self_test/selftest-token-post.json</filename>
            <vars>
                <var ID="TOKEN">${selftestToken.got("//data")}</var>
            </vars>
        </test>
        <test ID="selftestUseTokenPUT">
            <expectedCodes>200</expectedCodes>
            <method>PUT</method>
            <uri>/tagonomy?mock=true&amp;mutation=${this.mutation}</uri>
            <filename>_self_test/content-mutator-test.json</filename>
            <mutator type="ExcludeFields">
                <expected>
                    <code range="4xx">*</code>
                </expected>
            </mutator>
        </test>
        <test ID="selftestUseTokenDELETE">
            <expectedCodes>200</expectedCodes>
            <method>DELETE</method>
            <uri>/tagonomy?mock=true</uri>
        </test>
        <test ID="selftest501">
            <expectedCodes>501</expectedCodes>
            <method>PUT</method>
            <uri>/tagonomy?mock=501</uri>
            <filename>_self_test/content-mutator-test.json</filename>
        </test>
        <test ID="selftestScriptTest">
            <expectedCodes>200</expectedCodes>
            <method>POST</method>
            <uri>/tagonomy?mock=true</uri>
            <filename>_self_test/selftest-mutator.json</filename>
            <vars>
                <var ID="TOKEN">FOOTOKEN</var>
            </vars>
            <exports>
                <vars>
                    <var ID="GregorianDate"><![CDATA[${
                        if (kit != null) {
                            var ts = kit.gregorian.timestampUTC();
                            kit.out.println('');
                            kit.out.println('    ==> Running test script, in selftest.xml:selftestGroup:selftestScriptTest at '+ts);
                            kit.out.println('');
                            return ''+ts;
                        }
                        return "kit not defined in selftestScriptTest";
                    }]]></var>
                </vars>
            </exports>
        </test>


    </testGroup>



    <testGroup ID="debug"  autoDeletePOSTS="false">
        <test ID="selftestUseTokenPUT">
            <expectedCodes>200</expectedCodes>
            <method>PUT</method>
            <uri>/tagonomy?mock=true&amp;mutation=${this.mutation}</uri>
            <filename>_self_test/selftest-mutator.json</filename>
            <vars>
                <var ID="TOKEN">FOOTOKEN</var>
                <var ID="mutation">${this.mutation}</var>
            </vars>
            <mutator type="ExcludeFields">
                <expected>
                    <code range="5xx">mutation</code>
                    <code range="2x">*</code>
                </expected>
            </mutator>
        </test>
    </testGroup>



    <testGroup ID="bugs"  autoDeletePOSTS="false">
        <test ID="selftestUseTokenPUTbugs">
            <!-- This case causes errors to happen in the mutated child tests, but reading the json response borks the
                 parent so it doesn't display correctly, and the children seem like top-level tests.
                 Trace this to the code that breaks on the error and trap the error correctly.
            -->
            <expectedCodes>200</expectedCodes>
            <method>PUT</method>
            <uri>/tagonomy?mock=true</uri>
            <filename>_self_test/selftest-mutator.json</filename>
            <mutator type="ExcludeFields">
                <expected>
                    <code range="4xx">*</code>
                </expected>
            </mutator>
            <exports>
                <vars>
                    <var ID="plainString">${tools.encodeURLString("and these are my data 1 2 3 + % * left-brace:\u007B right-brace:\u007D ")}</var>
                    <var ID="encodedData2">${tools.encodeURLString(this.got("//data"))}</var>
                    <var ID="data">${this.got("//data")}</var>
                    <var ID="result">This case (result/this) is borked: ${result.got("//data")}</var>
                    <var ID="returnTest">${var d = this.got("//data"); if (d.length()>0) {return true;} else {return false;}}</var>
                </vars>
            </exports>
        </test>
        <test ID="selftestUseData"  autoDeletePOSTS="false">
            <expectedCodes>200</expectedCodes>
            <method>GET</method>
            <uri>/tagonomy?mock=token&amp;data=${tools.encodeURLString(selftestUseTokenPUTbugs.result)}</uri>
        </test>
    </testGroup>

    <testGroup ID="debugScript">
        <test ID="selftestReturnTest">
            <expectedCodes>200</expectedCodes>
            <method>POST</method>
            <uri>/tagonomy?mock=true</uri>
            <filename>_self_test/selftest-mutator.json</filename>
        </test>

    </testGroup>

</restReplay>
